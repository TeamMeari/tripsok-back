CREATE TABLE PLACE_TR
(
    PLACE_ID    NUMBER(10)        NOT NULL
        REFERENCES PLACE (ID) ON DELETE CASCADE,
    LOCALE      VARCHAR2(20 CHAR) NOT NULL,
    PLACE_NAME  VARCHAR2(255 CHAR),
    ADDRESS     VARCHAR2(255 CHAR),
    INFORMATION CLOB,
    SUMMARY     VARCHAR2(255 CHAR),
    CONSTRAINT PK_PLACE_TR PRIMARY KEY (PLACE_ID, LOCALE),
    -- (선택) 소문자/형식 체크
    CONSTRAINT CK_PLACE_TR_LOCALE_LOWER CHECK (LOCALE = LOWER(LOCALE)),
    CONSTRAINT CK_PLACE_TR_LOCALE_FMT
        CHECK (REGEXP_LIKE(LOCALE, '^[a-z]{2,3}(-[a-z0-9]{2,8})*$'))
);

CREATE INDEX IX_PLACE_TR_LOCALE ON PLACE_TR (LOCALE, PLACE_ID);

MERGE INTO PLACE_TR t
USING (SELECT ID                           AS PLACE_ID,
              'ko'                         AS LOCALE,
              NULLIF(TRIM(PLACE_NAME), '') AS PLACE_NAME,
              NULLIF(TRIM(ADDRESS), '')    AS ADDRESS,
              INFORMATION,
              NULLIF(TRIM(SUMMARY), '')    AS SUMMARY
       FROM PLACE) s
ON (t.PLACE_ID = s.PLACE_ID AND t.LOCALE = s.LOCALE)
WHEN MATCHED THEN
    UPDATE
    SET t.PLACE_NAME  = NVL(s.PLACE_NAME, t.PLACE_NAME),
        t.ADDRESS     = NVL(s.ADDRESS, t.ADDRESS),
        t.INFORMATION = NVL(s.INFORMATION, t.INFORMATION),
        t.SUMMARY     = NVL(s.SUMMARY, t.SUMMARY)
WHEN NOT MATCHED THEN
    INSERT
        (PLACE_ID, LOCALE, PLACE_NAME, ADDRESS, INFORMATION, SUMMARY)
    VALUES (s.PLACE_ID, s.LOCALE, s.PLACE_NAME, s.ADDRESS, s.INFORMATION, s.SUMMARY);


ALTER TABLE PLACE_LCLS_CATEGORY
    ADD LOCALE VARCHAR2(20 CHAR);

UPDATE PLACE_LCLS_CATEGORY
SET LOCALE = 'ko'
WHERE LOCALE IS NULL;

ALTER TABLE PLACE_LCLS_CATEGORY MODIFY LOCALE CONSTRAINT NN_PLLC_LOCALE NOT NULL;
ALTER TABLE PLACE_LCLS_CATEGORY
    ADD CONSTRAINT CK_PLLC_LOCALE_LOWER CHECK (LOCALE = LOWER(LOCALE));

ALTER TABLE PLACE_LCLS_CATEGORY
    DROP CONSTRAINT UQ_TOUR_LCLS_CATEGORY_CD;
ALTER TABLE PLACE_LCLS_CATEGORY
    ADD CONSTRAINT UQ_PLLC_LOCALE_L3CODE
        UNIQUE (LOCALE, LCLS_SYSTM3_CODE);

ALTER TABLE PLACE_LCLS_CATEGORY
    DROP CONSTRAINT PK_TOUR_LCLS_CATEGORY;
ALTER TABLE PLACE_LCLS_CATEGORY
    ADD CONSTRAINT PK_TOUR_LCLS_CATEGORY
        PRIMARY KEY (ID, LOCALE);

ALTER TABLE PLACE_LCLS_CATEGORY MODIFY (ID GENERATED BY DEFAULT ON NULL AS IDENTITY);
